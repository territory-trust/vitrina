<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Writer: Direct Link</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { 
            --bg: #0b0e14; 
            --card: #1c1326; 
            --accent: #bd00ff; 
            --text: #e0e6ed; 
            --success: #00ff41; 
        }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, sans-serif; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
        }
        
        .panel { 
            background: var(--card); 
            padding: 30px 20px; 
            border-radius: 20px; 
            border: 1px solid #4a1d63; 
            width: 100%; 
            max-width: 550px; 
            box-sizing: border-box; 
            box-shadow: 0 10px 40px rgba(189,0,255,0.2); 
        }
        
        h1 { 
            font-size: 24px; 
            color: var(--accent); 
            margin-bottom: 25px; 
            text-align: center; 
            font-weight: 800; 
            text-transform: uppercase; 
        }

        .velvet-btn { 
            background: linear-gradient(145deg, #7d00aa, #5a007a); 
            color: white; 
            padding: 25px; 
            border-radius: 16px; 
            border: 1px solid var(--accent); 
            width: 100%; 
            font-size: 22px; 
            font-weight: bold; 
            cursor: pointer; 
            text-transform: uppercase; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        #log { 
            margin-top: 25px; 
            background: #000; 
            padding: 20px; 
            border-radius: 12px; 
            font-family: 'Consolas', monospace; 
            font-size: 18px; 
            color: var(--accent); 
            border: 1px solid #333; 
            min-height: 350px; 
            line-height: 1.6; 
            overflow-y: auto; 
            text-align: left; 
        }
    </style>
</head>
<body>

    <div class="panel">
        <h1>–ò–ò-–û–ü–ò–°–ê–¢–ï–õ–¨ (DIRECT)</h1>
        <button class="velvet-btn" onclick="start()">üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –° –ö–õ–Æ–ß–û–ú ‚Ññ4</button>
        <div id="log">> –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞...</div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
        
        // –í–ê–® –ö–õ–Æ–ß ‚Ññ4 (–í—à–∏—Ç –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞)
        const DIRECT_KEY = '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';

        async function start() {
            const log = document.getElementById('log');
            
            log.innerHTML = `> –ö–ª—é—á –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ...${DIRECT_KEY.slice(-6)}`;
            log.innerHTML += `<br>> –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞...`;

            try {
                // 1. –ü–†–û–í–ï–†–ö–ê –ë–ê–õ–ê–ù–°–ê
                const bRes = await fetch("https://openrouter.ai/api/v1/user", {
                    headers: { 
                        "Authorization": `Bearer ${DIRECT_KEY}`,
                        "Content-Type": "application/json"
                    }
                });
                const bData = await bRes.json();

                if (!bData.data) {
                    log.innerHTML += `<br><span style="color:red">! –û–®–ò–ë–ö–ê: ${bData.error?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å"}</span>`;
                    // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è, –ø—Ä–æ–±—É–µ–º –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ –ø–æ–∫–∞–∑–∞–ª–æ
                } else {
                    const credits = bData.data.total_credits - bData.data.usage;
                    log.innerHTML += `<br><b style="color:#58a6ff">üí∞ –ë–ê–õ–ê–ù–°: $${credits.toFixed(4)}</b>`;
                }

                // 2. –ü–û–ò–°–ö –¢–û–í–ê–†–ê
                log.innerHTML += `<br>> –ò—â–µ–º —Ç–æ–≤–∞—Ä...`;
                const { data: products } = await supabaseClient.from('products')
                    .select('*').eq('is_processed_ai', false).limit(1);
                
                if (!products || products.length === 0) {
                    log.innerHTML += "<br>> –í—Å–µ —Ç–æ–≤–∞—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã."; return;
                }

                const p = products[0];
                log.innerHTML += `<br>> –ü–∏—à–µ–º –¥–ª—è: <b style="color:#fff">${p.title}</b>`;

                // 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø (–ò—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o-mini)
                const gptRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${DIRECT_KEY}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": "https://territory-trust.github.io", // –í–∞–∂–Ω–æ –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π
                        "X-Title": "Vitrina Project"
                    },
                    body: JSON.stringify({
                        model: "openai/gpt-4o-mini",
                        messages: [{
                            role: "user", 
                            content: `–ù–∞–ø–∏—à–∏ 2 –∫–æ—Ä–æ—Ç–∫–∏—Ö, –¥–æ—Ä–æ–≥–∏—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç–æ–≤–∞—Ä–∞: "${p.title}". –°—Ç–∏–ª—å: –ø—Ä–µ–º–∏—É–º, –ª–∞–∫–æ–Ω–∏—á–Ω–æ.`
                        }]
                    })
                });

                const gptData = await gptRes.json();
                
                if (gptData.error) {
                    throw new Error(gptData.error.message);
                }

                const desc = gptData.choices[0].message.content;
                
                // 4. –°–û–•–†–ê–ù–ï–ù–ò–ï
                await supabaseClient.from('ai_content').insert({ product_id: p.id, fancy_description: desc });
                await supabaseClient.from('products').update({ is_processed_ai: true }).eq('id', p.id);

                log.innerHTML += " <span style='color:var(--success)'>[–£–°–ü–ï–•]</span>";
                
                // –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
                setTimeout(start, 2500);

            } catch (err) {
                log.innerHTML += `<br><span style="color:red">! –°–ë–û–ô: ${err.message}</span>`;
            }
        }
    </script>
</body>
</html>
