<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Generator 2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0d0f12; --olive: #556b2f; --text: #d1d5db; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; text-align: center; font-size: 16px; }
        
        /* –ù–∞–≤—ñ–≥–∞—Ü—ñ—è */
        .system-nav { background: #000; padding: 10px; display: flex; justify-content: center; gap: 10px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .sys-btn { text-decoration: none; color: #888; font-size: 14px; padding: 8px 15px; border-radius: 6px; border: 1px solid #333; }
        .sys-btn:hover { color: #fff; border-color: var(--olive); }
        .sys-btn.active { background: var(--olive); color: #fff; border-color: var(--olive); }

        .panel { background: #14171c; padding: 30px; border-radius: 20px; border: 1px solid var(--olive); max-width: 600px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #444; background: #000; color: #fff; margin-bottom: 20px; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus { border-color: var(--olive); }

        .btn { background: linear-gradient(180deg, var(--olive) 0%, #3e4e22 100%); color: white; padding: 20px; border: none; width: 100%; border-radius: 15px; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-size: 18px; box-shadow: 0 4px 0 #2b3815; transition: 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-auto { background: linear-gradient(180deg, #b8860b 0%, #8b6508 100%); box-shadow: 0 4px 0 #5c4305; }

        #status { margin-top: 20px; background: #000; padding: 20px; border-radius: 12px; color: #00ff41; text-align: left; height: 300px; font-family: monospace; overflow-y: auto; font-size: 13px; border: 1px solid #333; line-height: 1.5; }
        
        .finish-link { display: none; margin-top: 20px; color: #fff; background: var(--olive); padding: 15px; border-radius: 10px; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="system-nav">
        <a href="index.html" class="sys-btn">üè† –í–Ü–¢–†–ò–ù–ê</a>
        <a href="scout_mta.html" class="sys-btn">üïµÔ∏è –†–û–ó–í–Ü–î–ù–ò–ö</a>
        <a href="agent_ai.html" class="sys-btn active">ü§ñ AI –ê–ì–ï–ù–¢</a>
    </div>

    <div class="panel">
        <h2 style="color:var(--olive); margin-top:0;">–ê–í–¢–û-–û–ü–ò–°–£–í–ê–ß (GEMINI 2.0)</h2>
        <p style="color:#888; margin-bottom:20px;">–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –æ–ø–∏—Å—ñ–≤ —Ç–∞ –Ω–∞–∑–≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.</p>
        
        <input type="password" id="key" placeholder="–í—Å—Ç–∞–≤—Ç–µ –≤–∞—à API Key —Å—é–¥–∏...">
        
        <button class="btn" onclick="start(false)">‚ö° –û–ë–†–û–ë–ò–¢–ò 20 –¢–û–í–ê–†–Ü–í</button>
        <button class="btn btn-auto" onclick="start(true)">üîÑ –ó–ê–ü–£–°–¢–ò–¢–ò –ê–í–¢–û-–†–ï–ñ–ò–ú (‚àû)</button>
        
        <div id="status">> –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∫–ª—é—á–∞ —Ç–∞ –∫–æ–º–∞–Ω–¥–∏...</div>
        <a href="index.html" id="finishBtn" class="finish-link">‚úÖ –†–û–ë–û–¢–£ –ó–ê–í–ï–†–®–ï–ù–û. –ü–ï–†–ï–ô–¢–ò –ù–ê –í–Ü–¢–†–ò–ù–£</a>
    </div>

    <script>
        const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
        let autoMode = false;

        async function start(isAuto) {
            autoMode = isAuto;
            const status = document.getElementById('status');
            const key = document.getElementById('key').value;
            const finishBtn = document.getElementById('finishBtn');

            if(!key) { alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–≤—Ç–µ API –∫–ª—é—á!"); return; }

            // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–µ–æ–±—Ä–æ–±–ª–µ–Ω—ñ —Ç–æ–≤–∞—Ä–∏
            const { data: products } = await sb.from('products').select('*').eq('is_processed_ai', false).limit(20);
            
            if(!products || products.length === 0) { 
                status.innerHTML += "<br><br>> ‚úÖ –í–°–Ü –¢–û–í–ê–†–ò –û–ë–†–û–ë–õ–ï–ù–Ü! –ë–∞–∑–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞."; 
                status.scrollTop = status.scrollHeight;
                finishBtn.style.display = "block";
                return; 
            }

            status.innerHTML += `<br>================================`;
            status.innerHTML += `<br>> –ó–Ω–∞–π–¥–µ–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –æ–±—Ä–æ–±–∫–∏...`;

            for (let p of products) {
                status.innerHTML += `<br>> –ì–µ–Ω–µ—Ä—É—é: ID-${p.id} (${p.category})...`;
                status.scrollTop = status.scrollHeight;

                try {
                    // –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini
                    const prompt = `–ó–∞–≤–¥–∞–Ω–Ω—è: –°—Ç–≤–æ—Ä–∏ –∫–∞—Ä—Ç–∫—É —Ç–æ–≤–∞—Ä—É –¥–ª—è —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—É.
                    –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: –ö–∞—Ç–µ–≥–æ—Ä—ñ—è "${p.category}", —É–º–æ–≤–Ω–∞ –Ω–∞–∑–≤–∞ "${p.title}".
                    
                    –í–∏–º–æ–≥–∏:
                    1. –ú–æ–≤–∞: –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞.
                    2. –°—Ç–∏–ª—å: –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π, —Ç–µ—Ö–Ω—ñ—á–Ω–∏–π, –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–∏–π.
                    3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (—Å—É–≤–æ—Ä–æ):
                       - –ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫: –ü—Ä–∏–≤–∞–±–ª–∏–≤–∞, –∫–æ—Ä–æ—Ç–∫–∞ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –Ω–∞–∑–≤–∞ (–¥–æ 60 —Å–∏–º–≤–æ–ª—ñ–≤). –ë–µ–∑ —Å–ª—ñ–≤ "–ê–∫—Ü—ñ—è" —á–∏ "–ö—É–ø–∏—Ç–∏".
                       - –î—Ä—É–≥–∏–π —Ä—è–¥–æ–∫ —ñ –¥–∞–ª—ñ: –û–ø–∏—Å —Ç–æ–≤–∞—Ä—É (3-4 —Ä–µ—á–µ–Ω–Ω—è) + 5 –∫–ª—é—á–æ–≤–∏—Ö —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Å–ø–∏—Å–∫–æ–º.
                    4. –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Markdown (*, #), —Ç—ñ–ª—å–∫–∏ —á–∏—Å—Ç–∏–π —Ç–µ–∫—Å—Ç.`;
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                        method: "POST", 
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await res.json();
                    
                    if(data.candidates && data.candidates[0].content) {
                        let txt = data.candidates[0].content.parts[0].text;
                        // –ß–∏—Å—Ç–∫–∞ –≤—ñ–¥ –∑–∞–π–≤–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤, —è–∫—â–æ AI —ó—Ö –¥–æ–¥–∞–≤
                        txt = txt.replace(/[*#`]/g, '').trim(); 
                        
                        // –†–æ–∑–¥—ñ–ª—è—î–º–æ –Ω–∞–∑–≤—É —Ç–∞ –æ–ø–∏—Å
                        const lines = txt.split('\n');
                        const newTitle = lines[0].substring(0, 100).trim(); // –ë–µ—Ä–µ–º–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ —è–∫ –Ω–∞–∑–≤—É
                        const description = lines.slice(1).join('\n').trim(); // –†–µ—à—Ç–∞ - –æ–ø–∏—Å

                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–ø–∏—Å –≤ –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é
                        await sb.from('ai_content').insert({ 
                            product_id: p.id, 
                            fancy_description: description || txt 
                        });

                        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —Ç–æ–≤–∞—Ä—É
                        await sb.from('products').update({ 
                            title: newTitle || p.title, 
                            is_processed_ai: true 
                        }).eq('id', p.id);

                        status.innerHTML += `<br>‚úî –ì–æ—Ç–æ–≤–æ: ${newTitle}`;
                    } else {
                        status.innerHTML += `<br>‚ùå –ü–æ–º–∏–ª–∫–∞ AI (–∫–≤–æ—Ç–∞ –∞–±–æ –∑–±—ñ–π)`;
                        console.error(data);
                    }

                    // –ü–∞—É–∑–∞ 1.5 —Å–µ–∫ —â–æ–± –Ω–µ –ø–µ—Ä–µ–≤–∏—â–∏—Ç–∏ –ª—ñ–º—ñ—Ç–∏ Google API
                    await new Promise(r => setTimeout(r, 1500));

                } catch(e) {
                    status.innerHTML += `<br>‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${e.message}`;
                }
            }

            if(autoMode) {
                status.innerHTML += `<br>> –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ü–∏–∫–ª—É...`;
                setTimeout(() => start(true), 1000);
            } else {
                status.innerHTML += `<br>> –ü–∞–∫–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É —â–µ —Ä–∞–∑.`;
            }
        }
    </script>
</body>
</html>
